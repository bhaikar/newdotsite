'use client';
import React, { useState, useEffect, useRef, useMemo } from 'react';
import Navbar from "@/components/navbar";
import Footer from "@/components/footer";
import Image from 'next/image';

const EventTimeline = () => {
  const [currentImageIndexes, setCurrentImageIndexes] = useState<{ [key: string]: number }>({});
  const timelineRef = useRef<HTMLDivElement>(null);
  const progressRef = useRef<HTMLDivElement>(null);
  const [activeItems, setActiveItems] = useState<Set<number>>(new Set());

  // Event data
  const events = useMemo(() => [
    {
      id: 1,
      year: "2K24",
      title: "Hack.MCE 4.0",
      images: [
        "/images/eventimages/HackMce4.0/1.jpg",
        "/images/eventimages/HackMce4.0/2.jpg",
        "/images/eventimages/HackMce4.0/3.jpg",
        "/images/eventimages/HackMce4.0/4.jpg",
        "/images/eventimages/HackMce4.0/5.jpg",
        "/images/eventimages/HackMce4.0/6.jpg"
      ],
      description: `HACK.MCE 4.0

Techno Gaming Fest 2024
Get Ready for the Ultimate Experience!
On Nov 22, Team DevOps hosted a thrilling state-level hackathon at MCE, bringing together brilliant minds to tackle the challenge of designing the MCE Student Hub! Creativity, collaboration, and innovation at their best!
On Nov 23, MCE hosted Cicada, a thrilling puzzle event crafted from scratch by our team! With 400 participants tackling intricate puzzles, it was a battle of wits, curiosity, and innovation. A memorable showcase of intellect and determination!
On Nov 24, MCE hosted an electrifying State-Level Gameathon featuring BGMI & Free Fire! With 200 gamers showcasing strategy, teamwork, and reflexes, it was a thrilling celebration of gaming culture and camaraderie.`
    },
    {
      id: 2,
      year: "2K23",
      title: "Hack.MCE 3.0",
      images: [
        "/images/eventimages/HackMce3.0/1.jpg",
        "/images/eventimages/HackMce3.0/2.jpg",
        "/images/eventimages/HackMce3.0/3.jpg",
        "/images/eventimages/HackMce3.0/4.jpg",
        "/images/eventimages/HackMce3.0/5.jpeg",
        "/images/eventimages/HackMce3.0/6.jpeg",
        "/images/eventimages/HackMce3.0/7.jpeg",
        "/images/eventimages/HackMce3.0/8.jpeg"
      ],
      description: `HACK.MCE 3.0

hosted by the DevOps team, was a grand event that took place on the 16th, 17th, and 22nd of December 2023. The festivities kicked off with the Gameathon, an eagerly anticipated inter-branch e-sports competition that energized the campus, with prelims held a week prior at the bustling college canteen.
The fest was more than just a competitionâ€”it was a celebration of creativity, collaboration, and community. It successfully brought together tech enthusiasts and gamers, fostering an environment of learning, networking, and fun. HACK.MCE 3.0 left a lasting impression, setting a high bar for future events and further solidifying its place as a premier tech and gaming fest in the college.`
    },
    {
      id: 3,
      year: "2K22",
      title: "Hack.MCE 2.0",
      images: [
        "/images/eventimages/HackMce2.0/1.jpeg",
        "/images/eventimages/HackMce2.0/2.jpeg",
        "/images/eventimages/HackMce2.0/3.jpeg",
        "/images/eventimages/HackMce2.0/6.jpeg",
        "/images/eventimages/HackMce2.0/7.jpeg"
      ],
      description: `HACK.MCE 2.0

The Techno Gaming Fest took place on the 18th and 19th of June 2022, featuring a dynamic lineup of tech-based events such as Debug, Circuitmania, and Webpage Designing, among many others. This grand fest wasn't just about tech; it also celebrated the spirit of gaming with Gameathon, an inter-branch e-sports event that brought out the competitive spirit among participants. The Gameathon prelims kicked off a week before the main event, creating a buzz in the college canteen as students gathered to showcase their gaming skills. The fest was a huge success, blending technology and gaming into an unforgettable experience for all attendees.`
    },
    {
      id: 4,
      year: "2k18",
      title: "Hack.MCE 1.0",
      images: [
        "/images/eventimages/HackMce1.0/1.jpeg",
        "/images/eventimages/HackMce1.0/2.jpeg",
        "/images/eventimages/HackMce1.0/3.jpeg",
        "/images/eventimages/HackMce1.0/4.jpeg"
      ],
      description: `HACK.MCE 1.0

A national-level Hackathon centered on the theme "Lifestyle" took place on the 28th, 29th, and 30th of October 2018. The event featured an intense 24-hour coding competition, where 80 students from various districts participated, showcasing their technical skills and creativity. In addition to the Hackathon, a workshop on the emerging topic of blockchain was conducted, providing participants with valuable insights into this cutting-edge technology. The event brought together a diverse group of tech enthusiasts, fostering innovation and learning in a collaborative environment.`
    },
    {
      id: 5,
      year: "2018",
      title: "DOT Bytes",
      images: [
        "/images/eventimages/DotBytes/1.png",
        "/images/eventimages/DotBytes/2.png",
        "/images/eventimages/DotBytes/3.png",
        "/images/eventimages/DotBytes/4.png"
      ],
      description: `Dot Bytes

The event .Bytes was successfully organized by the DevOps Team during the odd semester on the 3rd and 4th of November 2017. The event truly embodied the tagline, "Where Technology Meets Fun," as it creatively blended technical challenges with engaging activities, making technology both accessible and enjoyable for all participants
The event offered the team members valuable hands-on experience with software tools essential for application development, greatly enhancing their technical expertise. This not only inspired the students of MCE but also fostered a culture of innovation and creativity on campus.
Two standout events, Thief City and Phat Anthaheli, were major highlights of .Bytes. Thief City challenged participants with puzzles and problem-solving tasks rooted in coding and logic, while Phat Anthaheli brought a playful, competitive edge, pushing participants to think outside the box and apply their technical knowledge in novel ways. The success of .Bytes demonstrated the power of combining learning with fun, leaving a lasting impact on everyone involved and setting a high standard for future events`
    }
  ], []);

  // Image slider functionality - matches original behavior
  useEffect(() => {
    const intervalIds: { [key: string]: NodeJS.Timeout } = {};
    
    events.forEach((event) => {
      const eventKey = `event-${event.id}`;
      intervalIds[eventKey] = setInterval(() => {
        setCurrentImageIndexes(prev => ({
          ...prev,
          [eventKey]: ((prev[eventKey] || 0) + 1) % event.images.length
        }));
      }, 3000);
    });

    return () => {
      Object.values(intervalIds).forEach(intervalId => clearInterval(intervalId));
    };
  }, [events]);

  // Timeline scroll functionality - closer to original jQuery implementation
  useEffect(() => {
    let animationFrame: number;
    let isScrolling = false;

    const handleScroll = () => {
      if (isScrolling) return;
      isScrolling = true;

      animationFrame = requestAnimationFrame(() => {
        if (!timelineRef.current || !progressRef.current) {
          isScrolling = false;
          return;
        }

        const timelineItems = timelineRef.current.querySelectorAll('.timeline-item');
        const scrollY = window.scrollY;
        const windowHeight = window.innerHeight;
        const newActiveItems = new Set<number>();

        // More accurate progress line calculation matching original
        const firstPoint = timelineItems[0]?.querySelector('.timeline-point');
        const lastPoint = timelineItems[timelineItems.length - 1]?.querySelector('.timeline-point');
        
        if (firstPoint && lastPoint) {
          const firstPointOffset = (firstPoint as HTMLElement).offsetTop;
          const lastPointOffset = (lastPoint as HTMLElement).offsetTop;
          const scrollProgress = scrollY + windowHeight / 2;
          
          let progressHeight = 0;
          if (scrollProgress >= firstPointOffset) {
            progressHeight = Math.min(
              ((scrollProgress - firstPointOffset) / (lastPointOffset - firstPointOffset)) * 100,
              100
            );
          }
          progressRef.current.style.height = `${progressHeight}%`;
        }

        // Update active items - matches original 50% viewport logic
        timelineItems.forEach((item, index) => {
          const point = item.querySelector('.timeline-point');
          if (point) {
            const pointRect = (point as HTMLElement).getBoundingClientRect();
            if (pointRect.top + scrollY < scrollY + windowHeight * 0.5) {
              newActiveItems.add(index);
            }
          }
        });

        setActiveItems(newActiveItems);
        isScrolling = false;
      });
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleScroll);
    handleScroll(); // Initial call

    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('resize', handleScroll);
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
    };
  }, []);

  // Image slider component - matches original display toggle behavior
  const ImageSlider = ({ images, eventId }: { images: string[]; eventId: number }) => {
    const eventKey = `event-${eventId}`;
    const currentIndex = currentImageIndexes[eventKey] || 0;

    return (
      <div className="w-full h-auto flex justify-center overflow-hidden relative">
        {images.map((image, index) => (
          <Image
            key={index}
            src={image}
            alt={`Event ${eventId} - ${index + 1}`}
            width={640}
            height={360}
            className={`w-full h-auto transition-opacity duration-300 absolute top-0 left-0 hover:shadow-[5px_5px_50px_rgba(255,255,255,0.438),-5px_-5px_50px_rgba(255,255,255,0.438)] ${
              index === currentIndex ? 'opacity-100 visible' : 'opacity-0 invisible'
            }`}
            priority={index === 0}
            loading={index === 0 ? undefined : "lazy"}
          />
        ))}
        {/* Placeholder for height - matches original structure */}
        <Image
          src={images[0]}
          alt=""
          width={640}
          height={360}
          className="w-full h-auto opacity-0"
        />
      </div>
    );
  };

  return (
    <div className="bg-slate-900 text-white font-['Inter'] overflow-x-hidden min-h-screen">
      <Navbar />

      {/* Hero Section */}
      <div className="pt-32 pb-16 text-center px-4">
        <h1 className="text-6xl md:text-8xl font-bold mb-8 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 bg-clip-text text-transparent animate-pulse">
          Our Journey
        </h1>
        <p className="text-xl text-slate-400 max-w-4xl mx-auto leading-relaxed">
          From passionate beginners to industry leaders, explore the milestones that shaped our DevOps community. 
          Each event represents innovation, collaboration, and the relentless pursuit of technical excellence.
        </p>
      </div>

      {/* Timeline Section */}
      <div className="relative px-4 pb-20">
        <div className="max-w-6xl mx-auto">
          <div ref={timelineRef} className="relative">
            {/* Timeline line - centered on desktop, left on mobile */}
            <div className="absolute left-1/2 transform -translate-x-1/2 w-0.5 bg-slate-700 h-full md:left-8 md:transform-none">
              <div 
                ref={progressRef}
                className="w-full bg-gradient-to-b from-cyan-400 to-blue-500 transition-all duration-500"
                style={{ height: '0%' }}
              />
            </div>

            {/* Timeline items */}
            <div className="space-y-16">
              {events.map((event, index) => (
                <div 
                  key={event.id}
                  className="timeline-item relative"
                >
                  {/* Timeline point - centered on desktop, left on mobile */}
                  <div className={`timeline-point absolute left-1/2 transform -translate-x-1/2 md:left-8 md:translate-x-0 w-16 h-16 rounded-full border-4 flex items-center justify-center text-sm font-bold z-10 transition-all duration-500 ${
                    activeItems.has(index) 
                      ? 'bg-gradient-to-r from-cyan-400 to-blue-500 border-cyan-400 text-slate-900 shadow-lg shadow-cyan-400/50' 
                      : 'bg-slate-800 border-slate-600 text-slate-300'
                  }`}>
                    {event.year}
                  </div>

                  {/* Content card - alternating sides on desktop */}
                  <div className={`
                    ${index % 2 === 0 
                      ? 'md:w-[45%] md:mr-auto md:pr-16' // Left side cards
                      : 'md:w-[45%] md:ml-auto md:pl-16' // Right side cards  
                    }
                    w-full mt-8 md:mt-0
                  `}>
                    <div className={`bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl overflow-hidden shadow-2xl transition-all duration-700 hover:shadow-cyan-400/20 hover:shadow-2xl hover:scale-[1.02] ${
                      activeItems.has(index) 
                        ? 'opacity-100 transform translate-x-0' 
                        : `opacity-0 transform ${
                            index % 2 === 0 
                              ? '-translate-x-[200%] md:-translate-x-[200%]' // Slide from left
                              : 'translate-x-[200%] md:translate-x-[200%]'    // Slide from right
                          }`
                    }`}>
                      {/* Image slider */}
                      <ImageSlider images={event.images} eventId={event.id} />
                      
                      {/* Content */}
                      <div className="p-8">
                        <div className="flex items-center space-x-3 mb-4">
                          <div className="w-2 h-8 bg-gradient-to-b from-cyan-400 to-blue-500 rounded-full"></div>
                          <h3 className="text-2xl font-bold text-white">{event.title}</h3>
                        </div>
                        
                        <p className="text-slate-400 leading-relaxed whitespace-pre-line">
                          {event.description}
                        </p>
                        
                        <div className="mt-6 flex items-center text-cyan-400 hover:text-cyan-300 transition-colors cursor-pointer">
                          <span className="text-sm font-medium">View Details</span>
                          <svg className="w-4 h-4 ml-2 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
};

export default EventTimeline;